# -*- indent-tabs-mode: nil; -*-

@import scala.sys.process._

@given Conversion[`()`, Option[String]] = _.as[Option[String]]

@val bsh: String => String = _.replaceAll("([`\"\\\\$])", "\\\\$1")

@val tmp: String = "sh -c 'mktemp -up dotarrow'" .!! .stripTrailing .stripPrefix("dotarrow/")

@val cwd: String = s"""sh -c 'readlink -m dotarrow/tmp/$tmp'""" .!! .stripTrailing

@var ex: Option[String] = None

@val run: Option[String] => IO[Option[String]] = { it => IO.pure(it.flatMap { src =>  \
  if 0 == s"""sh -c 'echo -n "${bsh(src)}" >| "$cwd"/app/Main.hs'""" .!               \
  && 0 == s"""sh -c 'dotarrowAeson $tmp'""" .!                                        \
  && 0 == s"""sh -c 'dotarrowAeson2 $tmp'""" .!                                       \
  then                                                                                \
    Some(s"""sh -c 'cat "$cwd"/app/Main.hs'""" .!!)                                   \
  else                                                                                \
    None                                                                              \
})}

Init(src, ch) = œÑ /* println(src) */. ch</* Some(src.as[String]) */>.

Main = œÑ /* s"""sh -c 'cp -r dotarrow/"${args(0)}" "$cwd"'""" .! */.        \
       œÑ /* s"""sh -c 'cp ../dotarrow/aeson/json.in "$cwd".json'""" .! */.  \
       œÑ /* s"""sh -c 'touch "$cwd".txt'""" .! */.                          \
       ŒΩ(ch) ( ùüé                                                            \
             | ( ùüé                                                          \
               | !.ch(code)/* run */.                                       \
                   if /* 'code.nonEmpty */ = True                           \
                   then œÑ /* println('code.get) */. ch<code>.               \
                   else ch<>.                                               \
               )                                                            \
             | Init(/* s"""sh -c 'cat "$cwd"/app/Main.hs'""" .!! */, ch)    \
             )
